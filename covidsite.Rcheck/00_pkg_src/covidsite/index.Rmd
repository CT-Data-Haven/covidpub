---
title: "COVID-19 -- DRAFT Apr 2020"
---

```{r setup, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE,
  echo = FALSE,
  dpi = 300
)
```

```{r prep}
library(dplyr)
library(tidyr)
library(forcats)
library(purrr)
library(stringr)
library(readr)
library(lubridate)
library(billboarder)
library(knitr)
library(leaflet)
library(DT)

source("scripts/plotting_utils.R")
```


```{r main_vars}
counties <- tidycensus::fips_codes %>%
  filter(state == "CT") %>%
  mutate(county = str_remove(county, " County")) %>%
  pull(county)

town_county <- cwi::xwalk %>%
  mutate(county_code = substr(town_fips, 3, 5)) %>%
  distinct(county_code, town) %>%
  left_join(tidycensus::fips_codes %>% filter(state == "CT"), by = "county_code") %>% 
  select(county, town)

county <- read_csv("input_data/covid_ct_county_detailed.csv") %>%
  mutate(date = mdy(date),
         name = as_factor(name),
         level = name %>% 
           fct_collapse(state = "Connecticut", county = counties, other_level = "noid") %>%
           fct_relevel("state"))

town <- read_csv("input_data/covid_ct_town.csv") %>%
  pivot_longer(-Town, names_to = "Date", values_to = "Cases") %>%
  mutate(Date = mdy(Date)) %>%
  janitor::clean_names()

tests <- read_csv("input_data/covid_tests.csv") %>%
  mutate(date = mdy(date),
         name = "Connecticut")

date_range <- range(county$date)
date_range_fmt <- format(date_range, "%m/%d/%Y")
town_latest <- max(town$date)
town_latest_fmt <- format(town_latest, "%m/%d/%Y")
test_date_range <- range(tests$date)
test_date_range_fmt <- format(test_date_range, "%m/%d/%Y")

pops <- read_csv("input_data/total_pop_2018.csv")

```

## Latest statewide data: `r date_range_fmt[2]` {.font-italic}


This webpage provides graphics that are intended to communicate what we know about COVID-19 (also known as SARS-CoV-2) in Connecticut. These charts are not intended to predict any scenarios about the disease or the people affected by it. They merely reflect data we have already collected at the town, county, and state levels. To the extent possible, this webpage is updated daily. 

For the latest information from the Connecticut Department of Public Health, visit http://portal.ct.gov/Coronavirus

### Important data notes:

- Current testing protocols restrict tests to contact tracing and specimen sampling of individuals exhibiting severe symptoms. Test results also take several days to return after a specimen is collected and received. As such, counts of detected cases almost certainly underestimate the true number of people infected with COVID-19.

- **Detected cases** refer to individuals who tested positive for COVID-19 as confirmed by the State of Connecticut. *Due to current testing protocols, this number likely underestimates—possibly to a very large degree—the number of people who may currently have or have recovered from the disease.*

- **Hospitalizations** refer to patients who have been admitted to a hospital for complications arising from COVID-19. These are reported at the county level only and represent the county where the hospital is located, not the patient’s home county. On March 29, 2020, the State reported a change to the way hospitalizations were recorded and acknowledged that hospitalization counts prior to that date were underestimated. Hospitalization counts are only available starting on March 21.

- **Deaths** refer to individuals who tested positive for COVID-19 around the time of their death. This doesn't necessarily mean COVID-19 symptoms or complications specifically caused that person's death. *Because of testing protocols, this number is likely undercounted.*

- Some values are given as rates and are marked as such, where the number of cases is divided by population in order to meaningfully compare the relative magnitude of cases across areas.



```{r county_line_plot, fig.width=7, fig.height=5}
set.seed(1)
pal <- c("gray20", rcartocolor::carto_pal(9, "Vivid")[sample.int(8)]) %>%
  set_names(c("Connecticut", counties))
seq_pal <- rcartocolor::carto_pal(5, "SunsetDark")

set_theme("insight")

county_to_plot <- county %>%
  filter(name %in% c("Connecticut", counties)) %>%
  mutate(name = as_factor(name) %>% fct_reorder2(date, cases, .desc = FALSE),
         lbl = str_glue("{name}: {scales::comma(cases)}")) 

mondays <- seq(date_range[1], date_range[2], by = 1) %>%
  floor_date(unit = "week", week_start = 1) %>%
  unique()
```



```{r}
# only showing places with at least X number of cases
reg_thresh <- 50
```


### Detected cases by location as of `r date_range_fmt[2]`, of locations with at least `r reg_thresh` cases {.viz-title}

Rates are given here per 10,000 people by location—that is, a rate of 20 per 10,000 people in a town would mean that for every 10,000 residents of that town, an average of 20 people have tested positive for COVID-19.


```{r region_cases}


counts_table <- bind_rows(
  county %>% 
    select(level, name, date, cases) %>%
    mutate(name = fct_relabel(name, ~ifelse(. %in% counties, paste(., "County"), .))),
  town %>%
    select(name = town, date, cases) %>%
    mutate(level = "town")
) %>%
  filter(date == date_range[2], cases >= reg_thresh, level != "noid") %>%
  mutate(level = as_factor(level) %>%
           fct_relevel("state", "county", "town", "noid")) %>%
  left_join(town_county, by = c("name" = "town")) %>%
  left_join(pops %>% select(-level), by = "name") %>%
  # replace_na(list(county = "N/A")) %>%
  mutate(`Cases per 10k residents` = round(cases / total_pop * 1e4, digits = 1)) %>%
  arrange(level, county, name) %>%
  select(county, name, cases, `Cases per 10k residents`) %>%
  rename_all(str_to_sentence)

datatable(counts_table, 
          options = list(searching = FALSE, rowGroup = list(dataSrc = 0, emptyDataGroup = "State / counties")),
          rownames = FALSE) %>%
  formatRound("Cases", digits = 0) %>%
  formatRound(4, digits = 1)
```

```{r}
pop_race <- read_csv("input_data/race18.csv") %>%
  select(name, race, total_pop = estimate)
case_by_race <- read_csv("input_data/covid_ct_race.csv") %>%
  mutate(race = as_factor(race) %>% 
           fct_relabel(str_remove, "NH ") %>%
           fct_recode(Latino = "Hispanic"),
         date = mdy(date),
         name = "Connecticut") %>%
  inner_join(pop_race, by = c("name", "race")) %>%
  filter(date == max(date))

race_date <- unique(case_by_race$date)
race_date_fmt <- format(race_date, "%m/%d/%Y")

rates_by_race <- bind_rows(
  case_by_race %>% mutate(race = "Average"),
  case_by_race
) %>%
  group_by(name, date, race) %>%
  summarise_at(vars(cases, deaths, total_pop), sum) %>%
  mutate_at(vars(cases, deaths), list(rate_10k = ~round(. / total_pop * 1e4, digits = 1))) %>%
  ungroup() %>%
  filter(race != "Other") %>%
  mutate(race = as_factor(race) %>%
           fct_reorder(cases_rate_10k, .desc = TRUE) %>%
           fct_relevel("Average")) %>%
  arrange(race)

```

Early data suggest higher rates of detected cases among Black and Latino residents than average, and higher death rates among Black residents. Note that race/ethnicity is not known for all patients, particularly in case counts; as such, the average rates shown here are only of people whose race/ethnicity is known, and are therefore lower than total rates shown above. Rates are again given per 10,000 people by race/ethnicity.

Currently, data by both race/ethnicity and age are not publicly available, so these are only crude rates rather than the preferable age-adjusted ones that would account for differing age distributions in the population by race/ethnicity. For example, age-adjusted rates from New York City suggest that detected case rates may be higher among Latinos when accounting for age.

:::: {.row}

::: {.col-md-6}

### Crude rate of detected cases per 10,000 residents by race/ethnicity, statewide as of `r race_date_fmt`

```{r}
race_pal <- setNames(c("#888888", pal[c(2, 4, 9, 3)]), levels(rates_by_race$race))
billboarder(data = rates_by_race, height = 350) %>%
  bb_barchart(mapping = bbaes(x = race, y = cases_rate_10k, group = race), stack = TRUE, width = list(ratio = 0.5)) %>%
  bb_colors_manual(race_pal) %>%
  bb_legend(hide = TRUE) %>%
  bb_y_axis(label = list(text = "Cases per 10k", position = "outer-top"))
```

:::

::: {.col-md-6}

### Crude rate of COVID-19-related deaths per 10,000 residents by race/ethnicity, statewide as of `r race_date_fmt`

```{r}
billboarder(list(), data = rates_by_race, height = 350) %>%
  bb_barchart(mapping = bbaes(x = race, y = deaths_rate_10k, group = race), stack = TRUE, width = list(ratio = 0.5)) %>%
  bb_colors_manual(race_pal) %>%
  bb_legend(hide = TRUE) %>%
  bb_y_axis(label = list(text = "Deaths per 10k", position = "outer-top"))
```

:::

:::: 



### Counts of detected COVID-19 cases by county, `r date_range_fmt[1]` to `r date_range_fmt[2]` {.viz-title}

```{r county_bars, fig.width=7, fig.height=4}

county_to_plot %>%
  filter(name != "Connecticut") %>%
  arrange(date, name) %>%
  billboarder(list(data = list(order = "asc")), data = ., height = 400) %>%
  bb_barchart(mapping = bbaes(x = date, y = cases, group = name), stacked = TRUE) %>%
  bb_x_axis(label = list(text = NULL), type = "timeseries", 
            tick = list(format = "%m/%d", values = mondays)) %>%
  bb_y_axis(label = list(text = "Cases", position = "outer-top"),
            tick = list(format = htmlwidgets::JS("d3.format(',')"))) %>%
  bb_x_grid(show = TRUE) %>%
  bb_y_grid(show = TRUE) %>%
  bb_colors_manual(pal) %>%
  bb_legend(position = "right") %>%
  bb_tooltip(grouped = FALSE) %>%
  bb_title(padding = list(bottom = 20, top = 10), position = "top-left")
```

### Rate of detected cases by town, as of `r town_latest_fmt` {.viz-title}

Values shown here are rates per 10,000 people by town.


```{r case_map, fig.height=5, fig.width=7}
rad_scale <- function(x, max_rad = 25) {
  s <- sqrt(x)
  s / max(s) * max_rad
}
map_lbllr <- function(name, rate_10k, cases) {
  paste(
    htmltools::h5(name),
    htmltools::div(str_glue("Rate: {rate_10k} per 10k")),
    htmltools::div(str_glue("{cases} cases"))
  ) %>%
    htmltools::htmlEscape()
}
map_thresh <- 10
cases_sf <- cwi::town_sf %>%
  select(-GEOID) %>%
  sf::st_transform(4326) %>%
  # sf::st_centroid() %>%
  left_join(town %>% filter(date == date_range[2]), by = c("name" = "town")) %>%
  left_join(pops %>% select(name, total_pop), by = "name") %>%
  mutate(rate_10k = round(cases / total_pop * 1e4, digits = 1))

bbox <- cwi::town_sf %>%
  sf::st_transform(4326) %>%
  sf::st_buffer(1e-2) %>%
  sf::st_bbox() %>%
  as.numeric()

# color_scale <- colorBin(seq_pal, cases_sf$rate_10k, bins = 5)

leaflet(cases_sf, width = 700, height = 500, 
        options = leafletOptions(zoomSnap = 0.25, zoomDelta = 0.5, scrollWheelZoom = FALSE)) %>%
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4]) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#999999", fillColor = "#aaaaaa", weight = 1, fillOpacity = 0.1) %>%
  addCircleMarkers(data = sf::st_centroid(cases_sf),
                   radius = ~rad_scale(rate_10k), color = seq_pal[5], 
                   weight = 0, opacity = 0.8, fillOpacity = 0.4,
                   # label = ~str_glue("{name}: {rate_10k}"),
                   label = ~str_glue("{name}: {rate_10k} per 10k ({cases} cases)"),
                   labelOptions = labelOptions(className = "tooltip", direction = "top", offset = c(0, -10))) 
```



### Trends in statewide COVID-related testing, cases, hospitalizations, and deaths, `r test_date_range_fmt[1]` to `r test_date_range_fmt[2]` {.viz-title}

```{r state_stats, fig.width=7, fig.height=4.5}


test_x_cases <- county %>%
  inner_join(tests, by = c("name", "date")) %>%
  # filter(date == date_range[2]) %>%
  select(-level) %>%
  pivot_longer(-c(date, name), names_to = "measure") %>%
  mutate(measure = as_factor(measure) %>%
           fct_relevel("tests", "cases", "hospitalizations") %>%
           fct_recode("detected cases" = "cases") %>%
           fct_relabel(str_to_sentence)) %>%
  filter(!is.na(value)) %>%
  arrange(measure)

billboarder(data = test_x_cases, height = 450) %>%
  bb_linechart(mapping = bbaes(x = date, y = value, group = measure), type = "step") %>%
  bb_x_axis(label = list(text = NULL), type = "timeseries", 
            tick = list(format = "%m/%d", values = mondays)) %>%
  bb_y_axis(label = list(text = "Count", position = "outer-top"),
            tick = list(format = htmlwidgets::JS("d3.format(',')")),
            padding = list(bottom = 0)) %>%
  bb_x_grid(show = TRUE) %>%
  bb_y_grid(show = TRUE) %>%
  bb_colors_manual(set_names(pal[2:5], levels(test_x_cases$measure))) %>%
  bb_legend(position = "right") %>%
  # bb_tooltip(grouped = FALSE) %>%
  bb_title(padding = list(bottom = 20, top = 10), position = "top-left")

```

Note that counts of COVID-19-related hospitalizations are only available from March 21 onward.


Summarizing the past five days of trends helps to smooth out daily jumps or drops in the number of reported cases. Looking at the five days before that helps contextualize the most recent five-day period. 

### Change in number of detected new cases over 5-day periods {.viz-title}

```{r case_5day, message=TRUE, warning=TRUE}
# only including if each 5-day period involves more than N cases; otherwise have things like increases of 1700%
t5_thresh <- 10
elapsed <- county %>%
  mutate(days_ago = (date_range[2] - date) %>%
           str_pad(width = 2, side = "left", pad = "0") %>%
           paste0("t", .))

dates_elapsed <- elapsed %>%
  distinct(days_ago, date) %>%
  mutate(date = format(date, "%m/%d")) %>%
  tibble::deframe()

case_change <- elapsed %>%
  filter(level != "noid", days_ago %in% c("t00", "t05", "t10")) %>%
  select(days_ago, level, name, cases) %>%
  pivot_wider(names_from = days_ago, values_from = cases) %>%
  mutate(new_cases_t05_t10 = t05 - t10,
         new_cases_t00_t05 = t00 - t05,
         pct_change = (new_cases_t00_t05 - new_cases_t05_t10) / new_cases_t05_t10) %>%
  filter_at(vars(starts_with("new_cases")), ~ . >= t5_thresh)

change_table <- case_change %>%
  arrange(level, name) %>%
  select(-matches("^t\\d")) %>%
  pivot_longer(-c(level, name), names_to = "variable") %>%
  extract(variable, into = c("type", "end", "start"), "(^\\w+)_(t\\d{2})_(t\\d{2}$)", remove = FALSE) %>%
  mutate_at(vars(end, start), recode, !!!dates_elapsed) %>%
  mutate(type = coalesce(type, variable),
         lbl = ifelse(is.na(end), type, str_glue("{type}, {start} to {end}")) %>%
           clean_titles(),
         name = ifelse(level == "county", paste(name, "County"), as.character(name))) %>%
  select(Name = name, lbl, value) %>%
  pivot_wider(names_from = lbl)

# datatable(change_table,
#           options = list(searching = FALSE, order = list(list(4, "desc"))),
#           rownames = FALSE) %>%
#   formatRound(2:3, digits = 0) %>%
#   formatPercentage(4)

datatable(change_table,
          options = list(searching = FALSE, paging = FALSE, info = FALSE),
          rownames = FALSE) %>%
  formatRound(2:3, digits = 0) %>%
  formatPercentage(4)
```

```{r}
exec_orders <- tibble::tribble(
  ~date, ~order,
  "2020-03-24", "Non-essential business closures",
  "2020-03-17", "Restrictions on gatherings"
) %>%
  mutate(date = as.Date(date),
         lbl = str_glue("{format(date, '%m/%d')}: {order}")) %>%
  split(seq_along(.$date)) %>%
  map(function(x) list(value = x$date, text = x$order, class = "milestone"))

mob <- read_csv("https://raw.githubusercontent.com/descarteslabs/DL-COVID-19/master/DL-us-mobility-daterow.csv")  %>% 
  filter(admin_level == 0 | fips == "09" | admin1 == "Connecticut") %>% 
  arrange(admin_level) %>%
  mutate(name = coalesce(admin2, admin1, as.character(admin_level)) %>%
           as_factor() %>%
           fct_recode(US = "0"),
         m50_miles = round(measurements::conv_unit(m50, "km", "mi"), digit = 1)) %>%
  select(level = admin_level, name, date, samples, m50_miles, m50_index) %>%
  mutate(wkday = lubridate::wday(date, label = F)) %>%
  filter(between(wkday, 2, 6)) %>%
  filter(name %in% c("US", "Connecticut", "New Haven County"))

mob_date_range <- range(mob$date)
```

One way to measure the impact of social distancing measures is through the distances people travel each day. Anonymized cell phone data shows the average number of miles traveled by people within each county starting March 2. As statewide executive orders restricting public and private gatherings and limiting nonessential travel, these average distances traveled dropped steeply.

Note that these executive orders took effect in the evening but are dated here with the following day, as that is when they are likely to have had an impact on people's travel.

### Residents' average daily mobility in miles, `r format(mob_date_range[1], "%m/%d/%Y")` to `r format(mob_date_range[2], "%m/%d/%Y")` {.viz-title}

```{r mobility, fig.height=4.5, fig.width=7}
# mob_pal <- c(pal[c(3, 5, 7)], "gray50") %>% setNames(levels(mob$name2))
mob_pal <- c(pal[c(3, 4, 9)], rep("gray50", 7)) %>%
  setNames(c(c("US", "Connecticut", "New Haven County"), setdiff(levels(mob$name), c("US", "Connecticut", "New Haven County"))))

# mob_legend <- "function(name, color) {
#   return ['US', 'Connecticut', 'New Haven County'].indexOf(name) !== -1 ? '<span>' + name + '</span>' : '';
# }"


billboarder(data = mob, height = 450) %>%
  bb_linechart(mapping = bbaes(x = date, y = m50_miles, group = name)) %>%
  bb_x_axis(label = list(text = NULL), type = "timeseries", 
            tick = list(format = "%m/%d", values = mondays[mondays <= max(mob$date)])) %>%
  bb_y_axis(label = list(text = "Avg. mobility (miles)", position = "outer-top")) %>%
  bb_x_grid(show = TRUE, 
            lines = list(exec_orders$`1`, exec_orders$`2`)) %>%
  bb_y_grid(show = TRUE) %>%
  bb_colors_manual(mob_pal) %>%
  bb_legend(position = "right") %>%
  bb_tooltip()
```




```{r eval=FALSE, include=FALSE}
# for now leaving out doubling time because I'm not sure how to contextualize it for a general audience
elapsed %>%
  arrange(level, name, date) %>%
  group_by(level, name) %>%
  mutate(ratio = cases / lag(cases),
         days_ago = as.numeric(str_remove(days_ago, "t")),
         day_brk = cut(days_ago, breaks = c(0, 5, 10, Inf), labels = c("t00_t04", "t05_t09", "t10_plus"),
                       include.lowest = TRUE, right = FALSE)) %>%
  filter(day_brk != "t10_plus") %>%
  group_by(day_brk, add = TRUE) %>%
  summarise(mean_ratio = mean(ratio, na.rm = TRUE)) %>%
  mutate(doubling_time = round(log(2) / log(mean_ratio), digits = 1))
```


## Sources {.section-title}

* DataHaven analysis of data reported by the State of Connecticut daily and posted to the COVID-19 information portal, https://portal.ct.gov/Coronavirus
* Data from Descartes Lab, "Mobility Changes in Response to COVID-19," https://descarteslabs.com/mobility/




---

<footer>

Page last updated by DataHaven, `r format(today(), "%m/%d/%Y")`

</footer>