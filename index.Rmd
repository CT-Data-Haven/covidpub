---
title: "COVID-19 in Connecticut"
---

```{r setup, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE,
  echo = FALSE,
  dpi = 300
)
```

```{r prep}
library(dplyr)
library(tidyr)
library(forcats)
library(purrr)
library(stringr)
library(readr)
library(lubridate)
library(billboarder)
library(knitr)
library(leaflet)
library(DT)
library(htmltools)

source("scripts/plotting_utils.R")
```

```{r meta_n_main}
dfs <- list.files("input_data", pattern = ".csv", full.names = TRUE) %>%
  set_names(str_extract, "(?<=covid_)(\\w+)(?=\\.csv)") %>%
  map(read_csv)

town_county <- read_csv("input_data/county2town.csv")

counties <- unique(town_county$county) %>%
  str_remove(" County")

pal <- vivid %>%
  purrr::set_names(c("Connecticut", counties))

county <- dfs[["county"]] %>%
  mutate_at(vars(name, level), as_factor)

town <- dfs[["town"]]

tests <- dfs[["tests"]]

date_range <- range(county$date)
date_range_fmt <- format(date_range, "%m/%d/%Y")
town_latest <- max(town$date)
town_latest_fmt <- format(town_latest, "%m/%d/%Y")
test_date_range <- range(tests$date)
test_date_range_fmt <- format(test_date_range, "%m/%d/%Y")

pops <- read_csv("input_data/total_pop_2018.csv")
```

::: {.text-info #date-heading}

Latest statewide data: `r date_range_fmt[2]` 

:::

This webpage provides graphics that are intended to communicate what we know about COVID-19 (also known as SARS-CoV-2) in Connecticut. These charts are not intended to predict any scenarios about the disease or the people affected by it. They merely reflect data that [DataHaven](https://ctdatahaven.org) has already collected at the town, county, and state levels. To the extent possible, this webpage is updated daily. 

For the latest information from the Connecticut Department of Public Health, visit http://portal.ct.gov/Coronavirus

## Important data notes 

<button class="btn btn-sm btn-default" role="button" data-toggle="collapse" data-target="#infoContainer" aria-controls="infoContainer" aria-expanded="true">Show / hide</button>


::: {#infoContainer .panel .panel-default .collapse }

- While previous testing protocols restricted tests to contact tracing and specimen sampling of individuals exhibiting severe symptoms, these have since changed. For current information on testing, see [state guidance](https://portal.ct.gov/Coronavirus/Covid-19-Knowledge-Base/COVID-19-Testing). Note that because testing coverage is still limited, *counts of detected cases almost certainly underestimate the true number of people infected with COVID-19.*

- **Detected cases** refer to individuals who tested positive for COVID-19 as confirmed by the State of Connecticut. *Due to current testing protocols, this number likely underestimates—possibly to a very large degree—the number of people who may currently have or have recovered from the disease.*

- **Hospitalizations** refer to patients who have been admitted to a hospital for complications arising from COVID-19. These are reported at the county level only and represent the county where the hospital is located, not the patient’s home county. On March 29, 2020, the State reported a change to the way hospitalizations were recorded and acknowledged that hospitalization counts prior to that date were underestimated. Hospitalization counts are only available starting on March 21.

- **Deaths** refer to individuals who tested positive for COVID-19 around the time of their death. This doesn\'t necessarily mean COVID-19 symptoms or complications specifically caused that person\'s death. *Because of testing protocols, this number is likely undercounted.*

- Some values are given as rates and are marked as such, where the number of cases is divided by population in order to meaningfully compare the relative magnitude of cases across areas.

:::

## Statewide case counts and rates

```{r county_setup}
set.seed(1)

county_to_plot <- county %>%
  filter(name %in% c("Connecticut", counties)) %>%
  mutate(name = fct_reorder2(name, date, cases, .desc = FALSE),
         lbl = str_glue("{name}: {scales::comma(cases)}")) 

mondays <- seq(date_range[1], date_range[2], by = 1) %>%
  floor_date(unit = "week", week_start = 1) %>%
  unique()
mondays <- mondays[mondays >= min(county_to_plot$date)]

# only showing places with at least X number of cases
reg_thresh <- 50
```


### Detected cases by location as of `r date_range_fmt[2]`, of locations with at least `r reg_thresh` cases {.viz-title}

Rates are given here per 10,000 people by location—that is, a rate of 20 per 10,000 people in a town would mean that for every 10,000 residents of that town, an average of 20 people have tested positive for COVID-19.


```{r out_region_case_table}
counts_table <- bind_rows(
  county %>% 
    select(level, name, date, cases) %>%
    mutate(name = fct_relabel(name, ~ifelse(. %in% counties, paste(., "County"), .))),
  town %>%
    mutate(level = "town")
) %>%
  filter(date == date_range[2], cases >= reg_thresh, level != "noid") %>%
  mutate(level = as_factor(level) %>%
           fct_relevel("state", "county", "town", "noid")) %>%
  left_join(town_county, by = c("name" = "town")) %>%
  left_join(pops %>% select(-level), by = "name") %>%
  # replace_na(list(county = "N/A")) %>%
  mutate(`Cases per 10k residents` = round(cases / total_pop * 1e4, digits = 1)) %>%
  arrange(level, county, name) %>%
  select(county, name, cases, `Cases per 10k residents`) %>%
  rename_all(str_to_sentence)

datatable(counts_table, 
          options = list(searching = FALSE, rowGroup = list(dataSrc = 0, emptyDataGroup = "State / counties")),
          rownames = FALSE, style = "bootstrap", class = "table table-striped", 
          plugins = c("simple_incremental_bootstrap")) %>%
  formatRound("Cases", digits = 0) %>%
  formatRound(4, digits = 1)
```

```{r race_setup}
age_adj_race <- dfs[["age_adjusted_race"]] %>%
  mutate_at(vars(race, measure), as_factor) %>%
  filter(race %in% c("Average", "White", "Black", "Latino", "Asian")) %>%
  pivot_wider(id_cols = c(date, race), names_from = measure, values_from = rate_10k, names_glue = "{measure}_{.value}") %>%
  mutate(race = race %>%
           fct_reorder(cases_rate_10k, .desc = TRUE) %>% 
           fct_recode(Total = "Average") %>%
           fct_relevel("Total")) %>%
  arrange(race)

race_date <- unique(age_adj_race$date)
race_date_fmt <- format(race_date, "%m/%d/%Y")
```


Data show higher rates of detected cases and deaths among Black and Latino residents than other groups. The statewide total rates shown include patients without race/ethnicity given. Rates are again given per 10,000 people by race/ethnicity and adjusted for age. Statewide age-adjusted data became available in late May, and are preferable in comparing racial groups because they account for differing age distributions in populations.


:::: {.row}

::: {.col-sm-6}

### Age-adjusted rate of detected cases per 10,000 residents by race/ethnicity, statewide as of `r race_date_fmt` {.viz-title .minheight}

```{r out_race_bars1}
# keep same colors regardless of order
race_pal <- setNames(c("#888888", pal[c(2, 4, 9, 3)]), c("Total", "Black", "Latino", "White", "Asian"))
billboarder(data = age_adj_race, height = 350) %>%
  bb_barchart(mapping = bbaes(x = race, y = cases_rate_10k, group = race), stack = TRUE, width = list(ratio = 0.5)) %>%
  bb_colors_manual(race_pal) %>%
  bb_legend(hide = TRUE) %>%
  bb_y_axis(label = list(text = "Cases per 10k", position = "outer-top"))
```

:::

::: {.col-sm-6}

### Age-adjusted rate of COVID-19-related deaths per 10,000 residents by race/ethnicity, statewide as of `r race_date_fmt` {.viz-title .minheight}

```{r out_race_bars2}
billboarder(list(), data = age_adj_race, height = 350) %>%
  bb_barchart(mapping = bbaes(x = race, y = deaths_rate_10k, group = race), stack = TRUE, width = list(ratio = 0.5)) %>%
  bb_colors_manual(race_pal) %>%
  bb_legend(hide = TRUE) %>%
  bb_y_axis(label = list(text = "Deaths per 10k", position = "outer-top"))
```

:::

:::: 

## Cases by county and town

### Counts of detected COVID-19 cases by county, `r date_range_fmt[1]` to `r date_range_fmt[2]` {.viz-title}

```{r out_county_bars, fig.width=7, fig.height=4}
county_to_plot %>%
  filter(name != "Connecticut") %>%
  arrange(date, name) %>%
  billboarder(list(data = list(order = "asc")), data = ., height = 400) %>%
  bb_barchart(mapping = bbaes(x = date, y = cases, group = name), stacked = TRUE, width = list(ratio = 1)) %>%
  # bb_linechart(mapping = bbaes(x = date, y = cases, group = name), type = "area") %>%
  bb_x_axis(label = list(text = NULL), type = "timeseries", 
            tick = list(format = "%m/%d", values = mondays)) %>%
  bb_y_axis(label = list(text = "Cases", position = "outer-top"),
            tick = list(format = htmlwidgets::JS("d3.format(',')"))) %>%
  bb_x_grid(show = TRUE) %>%
  bb_y_grid(show = TRUE) %>%
  bb_colors_manual(pal) %>%
  # bb_legend(position = "right") %>%
  bb_tooltip(grouped = FALSE) %>%
  bb_title(padding = list(bottom = 20, top = 10), position = "top-left")
```

### Rate of detected cases by town, as of `r town_latest_fmt` {.viz-title}

Values shown here are rates per 10,000 people by town.


```{r map_setup}
rad_scale <- function(x, max_rad = 25) {
  s <- sqrt(x)
  s / max(s) * max_rad
}
map_lbllr <- function(name, rate_10k, cases) {
  paste(
    htmltools::h5(name),
    htmltools::div(str_glue("Rate: {rate_10k} per 10k")),
    htmltools::div(str_glue("{cases} cases"))
  ) %>%
    htmltools::htmlEscape()
}
map_thresh <- 10
cases_sf <- cwi::town_sf %>%
  # select(-GEOID) %>%
  sf::st_transform(4326) %>%
  left_join(town, by = "name") %>%
  top_n(1, date) %>%
  left_join(pops, by = "name") %>%
  mutate(rate_10k = round(cases / total_pop * 1e4, digits = 1))

bbox <- cwi::town_sf %>%
  sf::st_transform(4326) %>%
  sf::st_buffer(1e-2) %>%
  sf::st_bbox() %>%
  as.numeric()
```




```{r out_case_chor, fig.height=5, fig.width=7}
chor_brks <- ceiling(classInt::classIntervals(cases_sf$rate_10k, n = 5, style = "jenks")$brk)
chor_pal <- colorBin(RColorBrewer::brewer.pal(5, "BuPu"), domain = cases_sf$rate_10k, bins = chor_brks)
leaflet(cases_sf, width = "100%", height = 500, 
        options = leafletOptions(zoomSnap = 0.25, zoomDelta = 0.5, scrollWheelZoom = FALSE)) %>%
  setMaxBounds(bbox[1], bbox[2], bbox[3], bbox[4]) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(color = "#333333", weight = 0.6, fillOpacity = 0.8, 
              fillColor = ~chor_pal(rate_10k),
              label = ~str_glue("{name}: {rate_10k} per 10k ({scales::comma(cases, accuracy = 1)} cases)"),
              labelOptions = labelOptions(className = "tooltip", direction = "top", offset = c(0, -20)),
              highlightOptions = highlightOptions(fillOpacity = 1, bringToFront = TRUE, weight = 2)) %>%
  addLegend("bottomright", pal = chor_pal, values = ~rate_10k, opacity = 0.9, title = "Rate per 10k")
```

## Statewide trends over time

### Trends in statewide COVID-related testing, cases, hospitalizations, and deaths, `r test_date_range_fmt[1]` to `r test_date_range_fmt[2]` {.viz-title}

::: {.nomargin}

```{r out_state_trendlines, fig.width=7, fig.height=5.5}
test_x_cases <- county %>%
  inner_join(tests %>% select(-daily_tests), by = c("name", "date")) %>%
  select(-level) %>%
  pivot_longer(-c(date, name), names_to = "measure") %>%
  mutate(measure = as_factor(measure) %>%
           fct_relevel("tests", "cases", "hospitalizations") %>%
           fct_recode("detected cases" = "cases", "tests completed" = "tests") %>%
           fct_relabel(str_to_sentence)) %>%
  filter(!is.na(value)) %>%
  arrange(measure) %>%
  mutate(type = fct_collapse(measure, "Hospitalizations & deaths" = c("Hospitalizations", "Deaths")))
test_case_split <- test_x_cases %>% split(.$type)

# need extra space on third one for legend. 
test_case_charts <- list(
  df = test_case_split, 
  title = names(test_case_split), 
  h = c(170, 170, 190), 
  has_legend = c(FALSE, FALSE, TRUE)) %>%
  pmap(function(df, title, h, has_legend) {
    y_range <- c(0, max(df$value))
    brks <- scales::breaks_extended(n = 5)(y_range)
    billboarder(data = df, height = h) %>%
      bb_linechart(mapping = bbaes(x = date, y = value, group = measure), type = "step") %>%
      bb_x_axis(label = list(text = NULL), type = "timeseries",
                tick = list(format = "%m/%d", values = mondays)) %>%
      bb_y_axis(label = list(text = "Count", position = "outer-top"),
                tick = list(format = htmlwidgets::JS("d3.format(',')")),
                padding = list(bottom = 0)) %>%
      bb_axis(y = list(tick = list(values = brks))) %>%
      bb_x_grid(show = TRUE) %>%
      bb_y_grid(show = TRUE) %>%
      bb_colors_manual(set_names(pal[c(2:4, 9)], levels(test_x_cases$measure))) %>%
      bb_title(position = "top-center", text = title) %>%
      bb_legend(show = has_legend) %>%
      bb_tooltip(linked = list(name = "trend-tip"))
  })
# idk why walk(print) doesn't work for this
test_case_charts[[1]]
test_case_charts[[2]]
test_case_charts[[3]] 
```

:::



Note that counts of COVID-19-related hospitalizations are only available from March 21 onward.

```{r streak_setup}
# need to fill any possible gaps in data in order to mark off streaks accurately? or ok to assume direction continues across any possible gaps? currently aren't any anyways
hospital_change <- test_x_cases %>%
  filter(measure == "Hospitalizations") %>%
  arrange(date) %>%
  mutate(change = value - lag(value),
         direction = case_when(
           change == 0 ~ "Constant",
           change < 0 ~ "Decreasing",
           change > 0 ~ "Increasing"
         ),
         change_lbl = formatC(change, flag = "+"))

streak <- function(x) {
  durations <- rle(x)$lengths
  imap(durations, function(d, i) {
    rep(i, times = d)
  }) %>%
    flatten_dbl()
}

hosp_streaks <- hospital_change %>%
  mutate(strk = streak(direction)) %>%
  filter(change < 0) %>%
  group_by(strk) %>%
  summarise(day1 = min(date), day2 = max(date)) %>%
  mutate(n_days = as.numeric(day2 - day1))

longest_streak <- hosp_streaks %>%
  top_n(1, n_days) %>%
  pivot_longer(starts_with("day"), values_to = "date")

streak_fmt <- format(longest_streak$date, "%B %d")
streak_dur <- unique(longest_streak$n_days)

hosp_recent <- hospital_change %>%
  mutate(direction = as_factor(direction) %>%
           fct_relabel(tolower) %>%
           fct_relabel(str_replace, "ing$", "ed")) %>%
  select(date, change, direction) %>%
  mutate(lbl = ifelse(direction == "constant", 
                      "stayed the same as", 
                      str_glue("{direction} by {abs(change)} from"))) %>%
  top_n(1, date)

hosp_date_range <- format(range(hospital_change$date), "%m/%d/%Y")
```

The longest continuous decrease in hospitalizations was between `r streak_fmt[1]` and `r streak_fmt[2]`, a streak of `r streak_dur` days. On the most recent day of data (`r format(hosp_recent$date, "%m/%d")`), the number of people hospitalized `r hosp_recent$lbl` the previous day.

### Change in number of COVID-19-related hospitalizations from previous day, `r hosp_date_range[1]` to `r hosp_date_range[2]` {.viz-title}

```{r out_hospitalizations}
d3_flag <- "function(value, ratio, id, index) {
  return d3.format('+,')(value);
}"
hospital_change %>%
  filter(!is.na(change)) %>%
  billboarder(data = ., height = 300) %>%
  bb_barchart(mapping = bbaes(x = date, y = change, group = direction), 
              width = list(ratio = 1)) %>%
  bb_x_axis(label = list(text = NULL), type = "timeseries", 
            tick = list(format = "%m/%d", values = mondays)) %>%
  bb_y_axis(label = list(text = "Change in # hospitalized", position = "outer-top"),
            tick = list(format = htmlwidgets::JS("d3.format(',')"))) %>%
  bb_x_grid(show = TRUE) %>%
  bb_y_grid(show = TRUE) %>%
  bb_colors_manual(set_names(div_pal[c(1, 3, 5)], c("Decreasing", "Constant", "Increasing"))) %>%
  bb_legend(hide = c("Constant")) %>%
  bb_tooltip(format = list(
    value = htmlwidgets::JS(d3_flag)
  )) %>%
  bb_title(padding = list(bottom = 20, top = 10), position = "top-left")
```



Summarizing the past seven days of trends helps to smooth out daily jumps or drops in the number of reported cases. Looking at the seven days before that helps contextualize the most recent seven-day period. 

### Change in number of detected new cases over 7-day periods {.viz-title}

```{r out_case_5day}
# switching to 7 days
# only including if each 5-day period involves more than N cases; otherwise have things like increases of 1700%
t5_thresh <- 10
change_incrs <- seq(0, 2) * 7

elapsed <- county %>%
  mutate(days_ago = sprintf("t%02d", (date_range[2] - date)))

dates_elapsed <- elapsed %>%
  distinct(days_ago, date) %>%
  mutate(date = format(date, "%m/%d")) %>%
  tibble::deframe()

case_change <- elapsed %>%
  filter(level != "noid", parse_number(days_ago) %in% change_incrs) %>%
  select(days_ago, level, name, cases) %>%
  pivot_wider(names_from = days_ago, values_from = cases) %>%
  mutate(new_cases_t07_t14 = t07 - t14,
         new_cases_t00_t07 = t00 - t07,
         pct_change = (new_cases_t00_t07 - new_cases_t07_t14) / new_cases_t07_t14) %>%
  filter_at(vars(starts_with("new_cases")), ~ . >= t5_thresh)

change_table <- case_change %>%
  arrange(level, name) %>%
  select(-matches("^t\\d")) %>%
  pivot_longer(-c(level, name), names_to = "variable") %>%
  extract(variable, into = c("type", "end", "start"), "(^\\w+)_(t\\d{2})_(t\\d{2}$)", remove = FALSE) %>%
  # broken with new dplyr
  # mutate_at(vars(end, start), recode, !!!dates_elapsed) %>%
  mutate_at(vars(end, start), function(x) map_chr(x, ~ifelse(!is.na(.), names(dates_elapsed)[which(dates_elapsed == .)], NA))) %>%
  mutate(type = coalesce(type, variable),
         lbl = ifelse(is.na(end), type, str_glue("{type}, {start} to {end}")) %>%
           clean_titles(),
         name = ifelse(level == "county", paste(name, "County"), as.character(name))) %>%
  select(Name = name, lbl, value) %>%
  pivot_wider(names_from = lbl)

datatable(change_table,
          options = list(searching = FALSE, paging = FALSE, info = FALSE),
          rownames = FALSE, style = "bootstrap", class = "table table-striped") %>%
  formatRound(2:3, digits = 0) %>%
  formatPercentage(4)
```

## Mobility and policy impacts


```{r wk_testing_setup}
reopen_df <- tibble::tribble(
  ~date,        ~value, ~descr,
  "2020-06-20", 100000, "Phase 2 goal",
  "2020-05-20",  50000, "May 20 goal"
) %>%
  mutate(date = as.Date(date),
         lbl = str_glue("{descr}: {scales::number(value, scale = 1e-3, suffix = 'k')}"))

reopen <- reopen_df %>%
  split(seq_along(.$date)) %>%
  map(function(x) list(value = x$value, text = x$lbl, class = "milestone")) %>%
  unname()

# make sure there's at least 5 days of data in the week; just to keep from having weeks shown that aren't more or less over
# reshaping just bc of annoying bb tooltip. also leaves room for expansion
weekly_tests <- tests %>%
  group_by(name, monday = floor_date(date, unit = "weeks", week_start = 1)) %>%
  summarise(days_incl = n(),
            weekly_tests = sum(daily_tests)) %>%
  filter(between(monday, min(mondays), max(mondays)),
         days_incl >= 5) %>%
  pivot_longer(-name:-days_incl, names_to = "measure") %>%
  mutate(measure = as_factor(measure) %>% fct_relabel(clean_titles))

recent_wk_tests <- top_n(weekly_tests, 1, monday)
recent_test_num <- scales::number(recent_wk_tests$value, big.mark = ",")
wk_test_range <- range(weekly_tests$monday)
wk_test_dates <- format(wk_test_range, "%m/%d")
```

Governor Lamont's roadmap for the next phases of reopening ([pdf](https://portal.ct.gov/-/media/Office-of-the-Governor/News/20200526-Governors-Reopen-Report.pdf?la=en)) includes a goal of 100,000 tests per week in order to begin phase 2 on or around June 20. While the state has increased its testing capacity, the actual number of tests conducted per week still falls well below this goal. Most recently, in the week starting `r wk_test_dates[2]`, testing sites conducted a total of `r recent_test_num` tests.

### Statewide total tests conducted per week, weeks starting `r wk_test_dates[1]` to `r wk_test_dates[2]` {.viz-title}

```{r out_tests_per_wk, fig.width=7, fig.height=4.5}
billboarder(data = weekly_tests, height = 450) %>%
  bb_barchart(mapping = bbaes(x = monday, y = value, group = measure)) %>%
  bb_x_axis(label = list(text = "Week of", position = "outer-left"), type = "timeseries", 
            tick = list(format = "%m/%d", values = mondays)) %>%
  bb_y_axis(label = list(text = "Weekly tests", position = "outer-top"), max = max(reopen_df$value),
            tick = list(format = htmlwidgets::JS("d3.format(',')"))) %>%
  bb_x_grid(show = TRUE) %>%
  bb_y_grid(show = TRUE,
            lines = reopen) %>%
  bb_colors_manual(set_names(c(pal[6]), levels(weekly_tests$measure))) %>%
  bb_legend(show = FALSE)
```



```{r mobility_setup}
exec_orders <- tibble::tribble(
  ~date, ~order,
  "2020-03-24", "Non-essential business closures",
  "2020-03-17", "Restrictions on gatherings",
  "2020-05-20", "Phase 1 reopening (CT)"
) %>%
  mutate(date = as.Date(date),
         lbl = str_glue("{format(date, '%m/%d')}: {order}")) %>%
  split(seq_along(.$date)) %>%
  map(function(x) list(value = x$date, text = x$order, class = "milestone")) %>%
  unname()

mob <- read_csv("https://raw.githubusercontent.com/descarteslabs/DL-COVID-19/master/DL-us-mobility-daterow.csv")  %>% 
  filter(admin_level == 0 | fips == "09" | admin1 == "Connecticut") %>% 
  arrange(admin_level) %>%
  mutate(name = coalesce(admin2, admin1, as.character(admin_level)) %>%
           as_factor() %>%
           fct_recode(US = "0"),
         m50_miles = round(measurements::conv_unit(m50, "km", "mi"), digit = 1)) %>%
  select(level = admin_level, name, date, samples, m50_miles, m50_index) %>%
  mutate(wkday = lubridate::wday(date, label = F)) %>%
  filter(between(wkday, 2, 6)) %>%
  filter(name %in% c("US", "Connecticut", "New Haven County"))

mob_date_range <- range(mob$date)
```

One way to measure the impact of social distancing measures is through the distances people travel each day. Anonymized cell phone data shows the average number of miles traveled by people within each county starting March 2. As statewide executive orders restricting public and private gatherings and limiting nonessential travel, these average distances traveled dropped steeply.

Note that these executive orders took effect in the evening but are dated here with the following day, as that is when they are likely to have had an impact on people's travel.

### Residents' average daily mobility in miles, weekdays `r format(mob_date_range[1], "%m/%d/%Y")` to `r format(mob_date_range[2], "%m/%d/%Y")` {.viz-title}

```{r out_mobility, fig.height=4.5, fig.width=7}
# mob_pal <- c(pal[c(3, 5, 7)], "gray50") %>% setNames(levels(mob$name2))
mob_pal <- c(pal[c(3, 4, 9)], rep("gray50", 7)) %>%
  setNames(c(c("US", "Connecticut", "New Haven County"), setdiff(levels(mob$name), c("US", "Connecticut", "New Haven County"))))

billboarder(data = mob, height = 450) %>%
  bb_linechart(mapping = bbaes(x = date, y = m50_miles, group = name)) %>%
  bb_x_axis(label = list(text = NULL), type = "timeseries", 
            tick = list(format = "%m/%d", values = mondays[mondays <= max(mob$date)])) %>%
  bb_y_axis(label = list(text = "Avg. mobility (miles)", position = "outer-top"), padding = list(bottom = 0)) %>%
  bb_x_grid(show = TRUE, 
            lines = exec_orders) %>%
  bb_y_grid(show = TRUE) %>%
  bb_colors_manual(mob_pal) 
```




```{r doubling, eval=FALSE, include=FALSE}
# for now leaving out doubling time because I'm not sure how to contextualize it for a general audience
elapsed %>%
  arrange(level, name, date) %>%
  group_by(level, name) %>%
  mutate(ratio = cases / lag(cases),
         days_ago = as.numeric(str_remove(days_ago, "t")),
         day_brk = cut(days_ago, breaks = c(0, 5, 10, Inf), labels = c("t00_t04", "t05_t09", "t10_plus"),
                       include.lowest = TRUE, right = FALSE)) %>%
  filter(day_brk != "t10_plus") %>%
  group_by(day_brk, add = TRUE) %>%
  summarise(mean_ratio = mean(ratio, na.rm = TRUE)) %>%
  mutate(doubling_time = round(log(2) / log(mean_ratio), digits = 1))
```


## Sources {.section-title}

* DataHaven analysis of data reported by the State of Connecticut daily and posted to the COVID-19 information portal, https://portal.ct.gov/Coronavirus
* Data from Descartes Lab, "Mobility Changes in Response to COVID-19," https://descarteslabs.com/mobility/




---

<footer>

Page last updated by DataHaven, `r format(today(), "%m/%d/%Y")`

![](img/25th_logo_alpha.png){ width=200px }

</footer>